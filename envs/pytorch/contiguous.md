# contiguous

âŒšï¸: 2020å¹´8æœˆ9æ—¥

ğŸ“šå‚è€ƒ

----

æ€§èƒ½ï¼št**ransposeã€permute åä½¿ç”¨` contiguous` æ–¹æ³•åˆ™ä¼šé‡æ–°å¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ä¿è¯æ•°æ®æ˜¯åœ¨é€»è¾‘é¡ºåºå’Œå†…å­˜ä¸­æ˜¯ä¸€è‡´çš„ï¼Œè¿ç»­å†…å­˜å¸ƒå±€å‡å°‘äº†CPUå¯¹å¯¹å†…å­˜çš„è¯·æ±‚æ¬¡æ•°ï¼ˆè®¿é—®å†…å­˜æ¯”è®¿é—®å¯„å­˜å™¨æ…¢100å€[[5\]](https://zhuanlan.zhihu.com/p/64551412#ref_5)ï¼‰ï¼Œç›¸å½“äºç©ºé—´æ¢æ—¶é—´**ã€‚

æœ¬æ–‡è®²è§£äº†pytorchä¸­contiguousçš„å«ä¹‰ã€å®šä¹‰ã€å®ç°ï¼Œä»¥åŠcontiguouså­˜åœ¨çš„åŸå› ï¼Œécontiguousæ—¶çš„è§£å†³åŠæ³•ã€‚å¹¶å¯¹æ¯”äº†numpyä¸­çš„contiguousã€‚

**contiguous** æœ¬èº«æ˜¯å½¢å®¹è¯**ï¼Œ**è¡¨ç¤ºè¿ç»­çš„**ï¼Œ**å…³äº **contiguousï¼Œ**PyTorch æä¾›äº†**`is_contiguous`ã€`contiguous`**(å½¢å®¹è¯åŠ¨ç”¨)ä¸¤ä¸ªæ–¹æ³• ï¼Œåˆ†åˆ«ç”¨äºåˆ¤å®šTensoræ˜¯å¦æ˜¯ **contiguous** çš„ï¼Œä»¥åŠä¿è¯Tensoræ˜¯**contiguous**çš„ã€‚

## PyTorchä¸­çš„is_contiguousæ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿ

**`is_contiguous`**ç›´è§‚çš„è§£é‡Šæ˜¯**Tensoråº•å±‚ä¸€ç»´æ•°ç»„å…ƒç´ çš„å­˜å‚¨é¡ºåºä¸TensoræŒ‰è¡Œä¼˜å…ˆä¸€ç»´å±•å¼€çš„å…ƒç´ é¡ºåºæ˜¯å¦ä¸€è‡´**ã€‚

Tensorå¤šç»´æ•°ç»„åº•å±‚å®ç°æ˜¯ä½¿ç”¨ä¸€å—è¿ç»­å†…å­˜çš„1ç»´æ•°ç»„ï¼ˆ[è¡Œä¼˜å…ˆé¡ºåºå­˜å‚¨](https://link.zhihu.com/?target=http%3A//vra.github.io/2019/03/18/numpy-array-contiguous/)ï¼Œä¸‹æ–‡æè¿°ï¼‰ï¼ŒTensoråœ¨å…ƒä¿¡æ¯é‡Œä¿å­˜äº†å¤šç»´æ•°ç»„çš„å½¢çŠ¶ï¼Œåœ¨è®¿é—®å…ƒç´ æ—¶ï¼Œé€šè¿‡å¤šç»´åº¦ç´¢å¼•è½¬åŒ–æˆ1ç»´æ•°ç»„ç›¸å¯¹äºæ•°ç»„èµ·å§‹ä½ç½®çš„åç§»é‡å³å¯æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ã€‚æŸäº›Tensoræ“ä½œï¼ˆ[å¦‚transposeã€permuteã€narrowã€expand](https://link.zhihu.com/?target=https%3A//stackoverflow.com/questions/48915810/pytorch-contiguous)ï¼‰ä¸åŸTensoræ˜¯å…±äº«å†…å­˜ä¸­çš„æ•°æ®ï¼Œä¸ä¼šæ”¹å˜åº•å±‚æ•°ç»„çš„å­˜å‚¨ï¼Œä½†åŸæ¥åœ¨è¯­ä¹‰ä¸Šç›¸é‚»ã€å†…å­˜é‡Œä¹Ÿç›¸é‚»çš„å…ƒç´ åœ¨æ‰§è¡Œè¿™æ ·çš„æ“ä½œåï¼Œåœ¨è¯­ä¹‰ä¸Šç›¸é‚»ï¼Œä½†åœ¨å†…å­˜ä¸ç›¸é‚»ï¼Œå³ä¸è¿ç»­äº†ï¼ˆ*is not contiguous*ï¼‰ã€‚

å¦‚æœæƒ³è¦å˜å¾—è¿ç»­ä½¿ç”¨`contiguous`æ–¹æ³•ï¼Œå¦‚æœTensorä¸æ˜¯è¿ç»­çš„ï¼Œåˆ™ä¼šé‡æ–°å¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ä¿è¯æ•°æ®æ˜¯åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼Œå¦‚æœTensoræ˜¯è¿ç»­çš„ï¼Œåˆ™`contiguous`æ— æ“ä½œã€‚

### **è¡Œä¼˜å…ˆ**

è¡Œæ˜¯æŒ‡å¤šç»´æ•°ç»„ä¸€ç»´å±•å¼€çš„æ–¹å¼ï¼Œå¯¹åº”çš„æ˜¯åˆ—ä¼˜å…ˆã€‚C/C++ä¸­ä½¿ç”¨çš„æ˜¯è¡Œä¼˜å…ˆæ–¹å¼ï¼ˆrow majorï¼‰ï¼ŒMatlabã€Fortranä½¿ç”¨çš„æ˜¯åˆ—ä¼˜å…ˆæ–¹å¼ï¼ˆcolumn majorï¼‰ï¼ŒPyTorchä¸­Tensoråº•å±‚å®ç°æ˜¯Cï¼Œä¹Ÿæ˜¯ä½¿ç”¨è¡Œä¼˜å…ˆé¡ºåºã€‚ä¸¾ä¾‹è¯´æ˜å¦‚ä¸‹ï¼š

```python3
>>> t = torch.arange(12).reshape(3,4)
>>> t
tensor([[ 0,  1,  2,  3],
        [ 4,  5,  6,  7],
        [ 8,  9, 10, 11]])
```

äºŒç»´æ•°ç»„ t å¦‚å›¾1ï¼š

![img](imgs/v2-fab4cadc4e4c3faae2dd7971d0453001_720w.png)

å›¾1. 3X4çŸ©é˜µè¡Œä¼˜å…ˆå­˜å‚¨é€»è¾‘ç»“æ„



æ•°ç»„ t åœ¨å†…å­˜ä¸­å®é™…ä»¥ä¸€ç»´æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œé€šè¿‡ **flatten** æ–¹æ³•æŸ¥çœ‹ t çš„ä¸€ç»´å±•å¼€å½¢å¼ï¼Œå®é™…å­˜å‚¨å½¢å¼ä¸ä¸€ç»´å±•å¼€ä¸€è‡´ï¼Œå¦‚å›¾2ï¼Œ

```python3
>>> t.flatten()
tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11])
```



![img](imgs/v2-97f4682954a2d9e3aea2805350c635b3_720w.png)

å›¾2. 3X4çŸ©é˜µè¡Œä¼˜å…ˆå­˜å‚¨ç‰©ç†ç»“æ„



è€Œåˆ—ä¼˜å…ˆçš„å­˜å‚¨é€»è¾‘ç»“æ„å¦‚å›¾3ã€‚

![img](imgs/v2-18bffbbe980de7bf7c60183fb412f855_720w.png)

å›¾3. 3X4çŸ©é˜µåˆ—ä¼˜å…ˆå­˜å‚¨é€»è¾‘ç»“æ„



ä½¿ç”¨åˆ—ä¼˜å…ˆå­˜å‚¨æ—¶ï¼Œä¸€ç»´æ•°ç»„ä¸­å…ƒç´ é¡ºåºå¦‚å›¾4ï¼š

![img](imgs/v2-08d8d8815ee507213ccaf9d9d0de8d5b_720w.png)

å›¾4. 3X4çŸ©é˜µåˆ—ä¼˜å…ˆå­˜å‚¨ç‰©ç†ç»“æ„



è¯´æ˜ï¼šå›¾1ã€å›¾2ã€å›¾3ã€å›¾4æ¥è‡ªï¼š[What is the difference between contiguous and non-contiguous arrays?](https://link.zhihu.com/?target=https%3A//stackoverflow.com/a/26999092)

å›¾1ã€å›¾2ã€å›¾3ã€å›¾4 ä¸­é¢œè‰²ç›¸åŒçš„æ•°æ®è¡¨ç¤ºåœ¨åŒä¸€è¡Œï¼Œä¸è®ºæ˜¯è¡Œä¼˜å…ˆé¡ºåºã€æˆ–æ˜¯åˆ—ä¼˜å…ˆé¡ºåºï¼Œå¦‚æœè¦è®¿é—®çŸ©é˜µä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯é€šè¿‡åç§»æ¥å®ç°ï¼Œè¿™ä¸ªåç§»é‡ç§°ä¸º**æ­¥é•¿**(stride[[1\]](https://zhuanlan.zhihu.com/p/64551412#ref_1))ã€‚åœ¨è¡Œä¼˜å…ˆçš„å­˜å‚¨æ–¹å¼ä¸‹ï¼Œè®¿é—®è¡Œä¸­ç›¸é‚»å…ƒç´ ç‰©ç†ç»“æ„éœ€è¦åç§»1ä¸ªä½ç½®ï¼Œåœ¨åˆ—ä¼˜å…ˆå­˜å‚¨æ–¹å¼ä¸‹åç§»3ä¸ªä½ç½®ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦ *contiguous* ï¼Ÿ

**1. `torch.view`**ç­‰æ–¹æ³•æ“ä½œéœ€è¦è¿ç»­çš„Tensorã€‚

transposeã€permute æ“ä½œè™½ç„¶æ²¡æœ‰ä¿®æ”¹åº•å±‚ä¸€ç»´æ•°ç»„ï¼Œä½†æ˜¯æ–°å»ºäº†ä¸€ä»½Tensorå…ƒä¿¡æ¯ï¼Œå¹¶åœ¨æ–°çš„å…ƒä¿¡æ¯ä¸­çš„ é‡æ–°æŒ‡å®š strideã€‚**`torch.view`** æ–¹æ³•çº¦å®šäº†ä¸ä¿®æ”¹æ•°ç»„æœ¬èº«ï¼Œåªæ˜¯ä½¿ç”¨æ–°çš„å½¢çŠ¶æŸ¥çœ‹æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬åœ¨ transposeã€permute æ“ä½œåæ‰§è¡Œ viewï¼ŒPytorch ä¼šæŠ›å‡ºä»¥ä¸‹é”™è¯¯ï¼š

```text
invalid argument 2: view size is not compatible with input tensor's size and stride (at least one dimension 
spans across two contiguous subspaces). Call .contiguous() before .view(). 
at /Users/soumith/b101_2/2019_02_08/wheel_build_dirs/wheel_3.6/pytorch/aten/src/TH/generic/THTensor.cpp:213
```

ä¸ºä»€ä¹ˆ view æ–¹æ³•è¦æ±‚Tensoræ˜¯è¿ç»­çš„[[2\]](https://zhuanlan.zhihu.com/p/64551412#ref_2)ï¼Ÿè€ƒè™‘ä»¥ä¸‹æ“ä½œï¼Œ

```python3
>>>t = torch.arange(12).reshape(3,4)
>>>t
tensor([[ 0,  1,  2,  3],
        [ 4,  5,  6,  7],
        [ 8,  9, 10, 11]])
>>>t.stride()
(4, 1)
>>>t2 = t.transpose(0,1)
>>>t2
tensor([[ 0,  4,  8],
        [ 1,  5,  9],
        [ 2,  6, 10],
        [ 3,  7, 11]])
>>>t2.stride()
(1, 4)
>>>t.data_ptr() == t2.data_ptr() # åº•å±‚æ•°æ®æ˜¯åŒä¸€ä¸ªä¸€ç»´æ•°ç»„
True
>>>t.is_contiguous(),t2.is_contiguous() # tè¿ç»­ï¼Œt2ä¸è¿ç»­
(True, False)
```

t2 ä¸ t å¼•ç”¨åŒä¸€ä»½åº•å±‚æ•°æ® **`a`**ï¼Œå¦‚ä¸‹ï¼š

```text
[ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11]
```

ï¼Œä¸¤è€…ä»…æ˜¯strideã€shapeä¸åŒã€‚å¦‚æœæ‰§è¡Œ t2.view(-1) ï¼ŒæœŸæœ›è¿”å›ä»¥ä¸‹æ•°æ® **`b`**ï¼ˆä½†å®é™…ä¼šæŠ¥é”™ï¼‰ï¼š

```text
[ 0,  4,  8,  1,  5,  9,  2,  6, 10,  3,  7, 11]
```

åœ¨ **`a`** çš„åŸºç¡€ä¸Šä½¿ç”¨ä¸€ä¸ªæ–°çš„ stride æ— æ³•ç›´æ¥å¾—åˆ° **`b`** ï¼Œéœ€è¦å…ˆä½¿ç”¨ t2 çš„ stride (1, 4) è½¬æ¢åˆ° t2 çš„ç»“æ„ï¼Œå†åŸºäº t2 çš„ç»“æ„ä½¿ç”¨ stride (1,) è½¬æ¢ä¸ºå½¢çŠ¶ä¸º (12,)çš„ **`b`** ã€‚**ä½†è¿™ä¸æ˜¯viewå·¥ä½œçš„æ–¹å¼**ï¼Œ**view ä»…åœ¨åº•å±‚æ•°ç»„ä¸Šä½¿ç”¨æŒ‡å®šçš„å½¢çŠ¶è¿›è¡Œå˜å½¢**ï¼Œå³ä½¿ view ä¸æŠ¥é”™ï¼Œå®ƒè¿”å›çš„æ•°æ®æ˜¯ï¼š

```text
[ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11]
```

è¿™æ˜¯ä¸æ»¡è¶³é¢„æœŸçš„ã€‚ä½¿ç”¨**`contiguous`**æ–¹æ³•åè¿”å›æ–°Tensor t3ï¼Œé‡æ–°å¼€è¾Ÿäº†ä¸€å—å†…å­˜ï¼Œå¹¶ä½¿ç”¨ç…§ t2 çš„æŒ‰è¡Œä¼˜å…ˆä¸€ç»´å±•å¼€çš„é¡ºåºå­˜å‚¨åº•å±‚æ•°æ®ã€‚

```text
>>>t3 = t2.contiguous()
>>>t3
tensor([[ 0,  4,  8],
        [ 1,  5,  9],
        [ 2,  6, 10],
        [ 3,  7, 11]])
>>>t3.data_ptr() == t2.data_ptr() # åº•å±‚æ•°æ®ä¸æ˜¯åŒä¸€ä¸ªä¸€ç»´æ•°ç»„
False
```

å¯ä»¥å‘ç° tä¸t2 åº•å±‚æ•°æ®æŒ‡é’ˆä¸€è‡´ï¼Œt3 ä¸ t2 åº•å±‚æ•°æ®æŒ‡é’ˆä¸ä¸€è‡´ï¼Œè¯´æ˜ç¡®å®é‡æ–°å¼€è¾Ÿäº†å†…å­˜ç©ºé—´ã€‚

### ä¸ºä»€ä¹ˆä¸åœ¨`view` æ–¹æ³•ä¸­é»˜è®¤è°ƒç”¨`contiguous`æ–¹æ³•?

å› ä¸ºå†å²ä¸Š**`view`**æ–¹æ³•å·²ç»çº¦å®šäº†å…±äº«åº•å±‚æ•°æ®å†…å­˜ï¼Œè¿”å›çš„Tensoråº•å±‚æ•°æ®ä¸ä¼šä½¿ç”¨æ–°çš„å†…å­˜ï¼Œå¦‚æœåœ¨**`view`**ä¸­è°ƒç”¨äº†**`contiguous`**æ–¹æ³•ï¼Œåˆ™å¯èƒ½åœ¨è¿”å›Tensoråº•å±‚æ•°æ®ä¸­ä½¿ç”¨äº†æ–°çš„å†…å­˜ï¼Œè¿™æ ·æ‰“ç ´äº†ä¹‹å‰çš„çº¦å®šï¼Œç ´åäº†å¯¹ä¹‹å‰çš„ä»£ç å…¼å®¹æ€§ã€‚ä¸ºäº†è§£å†³ç”¨æˆ·ä½¿ç”¨ä¾¿æ·æ€§é—®é¢˜ï¼ŒPyTorchåœ¨0.4ç‰ˆæœ¬ä»¥åæä¾›äº†**`reshape`**æ–¹æ³•ï¼Œå®ç°äº†ç±»ä¼¼äº **`tensor.contigous().view(\*args)`**çš„åŠŸèƒ½ï¼Œå¦‚æœä¸å…³å¿ƒåº•å±‚æ•°æ®æ˜¯å¦ä½¿ç”¨äº†æ–°çš„å†…å­˜ï¼Œåˆ™ä½¿ç”¨**`reshape`**æ–¹æ³•æ›´æ–¹ä¾¿ã€‚ [[3\]](https://zhuanlan.zhihu.com/p/64551412#ref_3)

**2.** å‡ºäºæ€§èƒ½è€ƒè™‘

è¿ç»­çš„Tensorï¼Œè¯­ä¹‰ä¸Šç›¸é‚»çš„å…ƒç´ ï¼Œåœ¨å†…å­˜ä¸­ä¹Ÿæ˜¯è¿ç»­çš„ï¼Œè®¿é—®ç›¸é‚»å…ƒç´ æ˜¯çŸ©é˜µè¿ç®—ä¸­ç»å¸¸ç”¨åˆ°çš„æ“ä½œï¼Œè¯­ä¹‰å’Œå†…å­˜é¡ºåºçš„ä¸€è‡´æ€§æ˜¯ç¼“å­˜å‹å¥½çš„ï¼ˆ[What is a â€œcache-friendlyâ€ code?](https://link.zhihu.com/?target=https%3A//stackoverflow.com/a/16699282)[[4\]](https://zhuanlan.zhihu.com/p/64551412#ref_4)ï¼‰ï¼Œåœ¨å†…å­˜ä¸­è¿ç»­çš„æ•°æ®å¯ä»¥ï¼ˆä½†ä¸ä¸€å®šï¼‰è¢«é«˜é€Ÿç¼“å­˜é¢„å–ï¼Œä»¥æå‡CPUè·å–æ“ä½œæ•°æ®çš„é€Ÿåº¦ã€‚transposeã€permute åä½¿ç”¨**` contiguous`** æ–¹æ³•åˆ™ä¼šé‡æ–°å¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ä¿è¯æ•°æ®æ˜¯åœ¨é€»è¾‘é¡ºåºå’Œå†…å­˜ä¸­æ˜¯ä¸€è‡´çš„ï¼Œè¿ç»­å†…å­˜å¸ƒå±€å‡å°‘äº†CPUå¯¹å¯¹å†…å­˜çš„è¯·æ±‚æ¬¡æ•°ï¼ˆè®¿é—®å†…å­˜æ¯”è®¿é—®å¯„å­˜å™¨æ…¢100å€[[5\]](https://zhuanlan.zhihu.com/p/64551412#ref_5)ï¼‰ï¼Œç›¸å½“äºç©ºé—´æ¢æ—¶é—´ã€‚

------

## PyTorchä¸­å¼ é‡æ˜¯å¦è¿ç»­çš„å®šä¹‰

å¯¹äºä»»æ„çš„ *k* ç»´å¼ é‡ *t* ,å¦‚æœæ»¡è¶³å¯¹äºæ‰€æœ‰ *i*ï¼Œç¬¬ *i* ç»´ç›¸é‚»å…ƒç´ é—´éš” = ç¬¬ *i*+1 ç»´ç›¸é‚»å…ƒç´ é—´éš” ä¸ ç¬¬ *i*+1 ç»´é•¿åº¦çš„ä¹˜ç§¯ï¼Œåˆ™ *t* æ˜¯è¿ç»­çš„ã€‚

![[å…¬å¼]](https://www.zhihu.com/equation?tex=%5Cforall+i%3D0%2C+%5Cdots%2C+k-1+%28i%5Cnot%3Dk-1%29%2C+%5Cspace+stride%5Bi%5D%3Dstride%5Bi%2B1%5D%C3%97size%5Bi%2B1%5D) [[6\]](https://zhuanlan.zhihu.com/p/64551412#ref_6)

- ä½¿ç”¨ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=stride%5Bi%5D) è¡¨ç¤ºç¬¬ *i* ç»´ç›¸é‚»å…ƒç´ ä¹‹é—´é—´éš”çš„ä½æ•°ï¼Œç§°ä¸ºæ­¥é•¿ï¼Œå¯é€šè¿‡ [stride](https://link.zhihu.com/?target=https%3A//pytorch.org/docs/stable/tensors.html%23torch.Tensor.stride) æ–¹æ³•è·å¾—ã€‚
- ä½¿ç”¨![[å…¬å¼]](https://www.zhihu.com/equation?tex=size%5Bi%5D) è¡¨ç¤ºå›ºå®šå…¶ä»–ç»´åº¦æ—¶ï¼Œç¬¬ *i* ç»´å…ƒç´ æ•°é‡ã€‚

## PyTorchä¸­åˆ¤è¯»å¼ é‡æ˜¯å¦è¿ç»­çš„å®ç°

PyTorchä¸­é€šè¿‡è°ƒç”¨ **is_contiguous** æ–¹æ³•åˆ¤æ–­ tensor æ˜¯å¦è¿ç»­ï¼Œåº•å±‚å®ç°ä¸º TH åº“ä¸­[THTensor.isContiguous](https://link.zhihu.com/?target=https%3A//github.com/pytorch/pytorch/blob/a7f6b0ab4fa4e43a2fa7bcb53825277db88b55f0/torch/lib/TH/generic/THTensor.c%23L639-L654) æ–¹æ³•ï¼Œä¸ºæ–¹ä¾¿åŠ ä¸Šä¸€äº›è°ƒè¯•ä¿¡æ¯ï¼Œç¿»è¯‘ä¸º Python ä»£ç å¦‚ä¸‹ï¼š

```text
def isContiguous(tensor):
    """
    åˆ¤æ–­tensoræ˜¯å¦è¿ç»­    
    :param torch.Tensor tensor: 
    :return: bool
    """

    z = 1
    d = tensor.dim() - 1
    size = tensor.size()
    stride = tensor.stride()
    print("stride={} size={}".format(stride, size))
    while d >= 0:
        if size[d] != 1:
            if stride[d] == z:
                print("dim {} stride is {}, next stride should be {} x {}".format(d, stride[d], z, size[d]))
                z *= size[d]                
            else:
                print("dim {} is not contiguous. stride is {}, but expected {}".format(d, stride[d], z))
                return False
        d -= 1
    return True
```

åˆ¤å®šä¸Šæ–‡ä¸­ tã€t2 æ˜¯å¦è¿ç»­çš„è¾“å‡ºå¦‚ä¸‹ï¼š

```text
>>>isContiguous(t)
stride=(4, 1) size=torch.Size([3, 4])
dim 1 stride is 1, next stride should be 1 x 4
dim 0 stride is 4, next stride should be 4 x 3

True
>>>isContiguous(t2)
stride=(1, 4) size=torch.Size([4, 3])
dim 1 is not contiguous. stride is 4, but expected 1

False
```

ä» **isContiguous** å®ç°å¯ä»¥çœ‹å‡ºï¼Œæœ€å1ç»´çš„ stride å¿…é¡»ä¸º1ï¼ˆé€»è¾‘æ­¥é•¿ï¼‰ï¼Œè¿™æ˜¯åˆç†çš„ï¼Œæœ€å1ç»´å³é€»è¾‘ç»“æ„ä¸Šæœ€å†…å±‚æ•°ç»„ï¼Œå…¶ç›¸é‚»å…ƒç´ é—´éš”ä½æ•°ä¸º1ï¼ŒæŒ‰è¡Œä¼˜å…ˆé¡ºåºæ’åˆ—æ—¶ï¼Œæœ€å†…å±‚æ•°ç»„ç›¸é‚»å…ƒç´ é—´éš”åº”è¯¥ä¸º1ã€‚

## numpyä¸­å¼ é‡æ˜¯å¦è¿ç»­çš„å®šä¹‰

å¯¹äºä»»æ„çš„ *N* ç»´å¼ é‡ *t* ï¼Œå¦‚æœæ»¡è¶³ç¬¬ *k* ç»´ç›¸é‚»å…ƒç´ é—´éš” = ç¬¬ *K*+1ç»´ è‡³ æœ€åä¸€ç»´çš„é•¿åº¦çš„ä¹˜ç§¯ï¼Œåˆ™ *t* æ˜¯è¿ç»­çš„ã€‚

- ä½¿ç”¨ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=s_%7Bk%7D%5E%7B%5Cmathrm%7Brow%7D%7D) è¡¨ç¤ºè¡Œä¼˜å…ˆæ¨¡å¼ä¸‹ï¼Œç¬¬ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=k)ç»´åº¦ç›¸é‚»ä¸¤ä¸ªå…ƒç´ ä¹‹é—´åœ¨å†…å­˜ä¸­é—´éš”çš„å­—èŠ‚æ•°ï¼Œå¯é€šè¿‡ [strides](https://link.zhihu.com/?target=https%3A//docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.strides.html%23numpy.ndarray.strides) å±æ€§è·å¾—ã€‚
- ä½¿ç”¨ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=itemsize) è¡¨ç¤ºæ¯ä¸ªå…ƒç´ çš„å­—èŠ‚æ•°ï¼ˆæ ¹æ®æ•°æ®ç±»å‹è€Œå®šï¼Œå¦‚PyTorchä¸­ *int32* ç±»å‹æ˜¯ 4ï¼Œ*int64* æ˜¯8ï¼‰ã€‚
- ä½¿ç”¨ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=d_%7Bj%7D) è¡¨ç¤ºå›ºå®šå…¶ä»–ç»´åº¦æ—¶ï¼Œç¬¬ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=j) ç»´å…ƒç´ çš„ä¸ªæ•°ï¼Œå³ t.shape[j]ã€‚

![[å…¬å¼]](https://www.zhihu.com/equation?tex=s_%7Bk%7D%5E%7B%5Cmathrm%7Brow%7D%7D%3D%5Ctext+%7B+itemsize+%7D+%5Cprod_%7Bj%3Dk%2B1%7D%5E%7BN-1%7D+d_%7Bj%7D) [[7\]](https://zhuanlan.zhihu.com/p/64551412#ref_7)

## PyTorchä¸numpyä¸­contiguouså®šä¹‰çš„å…³ç³»

PyTorchå’Œnumpyä¸­å¯¹äºcontiguousçš„å®šä¹‰çœ‹èµ·æ¥æœ‰å·®å¼‚ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€è‡´çš„ã€‚

é¦–å…ˆå¯¹äº strideçš„å®šä¹‰æŒ‡çš„éƒ½æ˜¯æŸç»´åº¦ä¸‹ï¼Œç›¸é‚»å…ƒç´ ä¹‹é—´çš„é—´éš”ï¼ŒPyTorchä¸­çš„ stride æ˜¯é—´éš”çš„ä½æ•°ï¼ˆå¯çœ‹ä½œé€»è¾‘æ­¥é•¿ï¼‰ï¼Œè€Œnumpy ä¸­çš„ stride æ˜¯é—´éš”çš„å­—èŠ‚æ•°ï¼ˆå¯çœ‹ä½œç‰©ç†æ­¥é•¿ï¼‰ï¼Œä¸¤ç§ stride çš„æ¢ç®—å…³ç³»ä¸ºï¼š ![[å…¬å¼]](https://www.zhihu.com/equation?tex=stride_%7Bnumpy%7D+%3D+itemsize+%5Ccdot+stride_%7Bpytorch%7D+) ã€‚

å†çœ‹å¯¹äº stride çš„è®¡ç®—å…¬å¼ï¼ŒPyTorch å’Œ numpy ä»ä¸åŒè§’åº¦ç»™å‡ºäº†å…¬å¼ã€‚PyTorch ç»™å‡ºçš„æ˜¯ä¸€ä¸ªé€’å½’å¼å®šä¹‰ï¼Œæè¿°äº†ä¸¤ä¸ªç›¸é‚»ç»´åº¦ stride ä¸ size ä¹‹é—´çš„å…³ç³»ã€‚numpy ç»™å‡ºçš„æ˜¯ç›´æ¥å®šä¹‰ï¼Œæè¿°äº† stride ä¸ shape çš„å…³ç³»ã€‚PyTorchä¸­çš„ size ä¸ numpy ä¸­çš„ shape å«ä¹‰ä¸€è‡´ï¼Œéƒ½æ˜¯æŒ‡ tensor çš„å½¢çŠ¶ã€‚ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=size%5Bi%2B1%5D) ã€ ![[å…¬å¼]](https://www.zhihu.com/equation?tex=shape%5Bj%5D) éƒ½æ˜¯æŒ‡å½“å›ºå®šå…¶ä»–ç»´åº¦æ—¶ï¼Œè¯¥ç»´åº¦ä¸‹å…ƒç´ çš„æ•°é‡ã€‚